"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.9.2"
__checksum__ = "b584ac35c9f3b3d0c5c4bc580306c7fd27aea2941962c6c8235b31270d37b252"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 22), (152, 7), (159, 20), (179, 18), None, (197, 22), (219, 45), (264, 7), (271, 9), (280, 36), (316, 10), (326, 10), (336, 21), None, (357, 50), (407, 8), (415, 9), (424, 19), (443, 13), (456, 14), (470, 14), None, None, (484, 29), (513, 16), (529, 35), (564, 14), (578, 24), (602, 9), None, (611, 25), (636, 20), (656, 8), (664, 13), (677, 10), None, (687, 17), (704, 6), (710, 26), (736, 5), (741, 5), (746, 10), (756, 10), (766, 11), (777, 12), (789, 27), None, (816, 11), (827, 11), (838, 7), (845, 29), (874, 18), (892, 27), (919, 46), (965, 25), (990, 16), (1006, 8), (1014, 5), (1019, 22), (1041, 18), None, (1059, 36), (1095, 15), (1110, 8), (1118, 11), None, (1129, 5), (1134, 16), (1150, 14), (1164, 18), None, (1182, 14), (1196, 18), (1214, 48), (1262, 19), (1281, 5), (1286, 46), (1332, 14), (1346, 14), (1360, 20), None, (1380, 10), (1390, 13), (1403, 10), (1413, 19), None, (1432, 13), (1445, 19), (1464, 5), (1469, 4), (1473, 22), (1495, 10), (1505, 7), (1512, 14), (1526, 21), (1547, 11), (1558, 10), (1568, 12), (1580, 32), None, (1612, 10), (1622, 14), (1636, 12), (1648, 45), (1693, 15), None, (1708, 11), (1719, 23), (1742, 21), (1763, 26), (1789, 6), (1795, 6), (1801, 7), (1808, 5), (1813, 20), (1833, 23), (1856, 24), (1880, 13), (1893, 15), (1908, 19), (1927, 6), (1933, 61), (1994, 44), (2038, 12), (2050, 23), (2073, 16), (2089, 38), (2127, 6), (2133, 12), (2145, 44), (2189, 6), (2195, 41), (2236, 13), (2249, 23), (2272, 30), (2302, 16), (2318, 8), (2326, 15), (2341, 12), (2353, 19), (2372, 21), (2393, 15), None, (2408, 35), (2443, 21), (2464, 17), (2481, 19), (2500, 26), (2526, 5), (2531, 37), (2568, 30), (2598, 16), (2614, 10), (2624, 17), (2641, 23), (2664, 14), (2678, 17), (2695, 8), (2703, 4), (2707, 7), (2714, 29), (2743, 6), (2749, 18), (2767, 27), (2794, 20), (2814, 17), (2831, 19), (2850, 12), (2862, 40), (2902, 40), (2942, 12), (2954, 48), (3002, 25), (3027, 12), None, (3039, 8), (3047, 20), (3067, 19), (3086, 6), (3092, 23), None, (3115, 30), (3145, 33), (3178, 14), (3192, 12), (3204, 27), None, (3231, 26), (3257, 31), (3288, 50), (3338, 15), (3353, 20), (3373, 15), (3388, 21), (3409, 32), (3441, 24), (3465, 20), (3485, 13), (3498, 60), (3558, 19), (3577, 9), (3586, 12), (3598, 12), (3610, 11), (3621, 10), (3631, 48), (3679, 32), None, (3711, 25), (3736, 12), None, (3748, 8), (3756, 8), (3764, 7), None, (3771, 25), (3796, 17), None, (3813, 21), (3834, 35), (3869, 12), (3881, 10), (3891, 36), (3927, 20), (3947, 22), (3969, 23), (3992, 19), (4011, 12), (4023, 5), (4028, 30), (4058, 24), (4082, 14), (4096, 14), (4110, 47), (4157, 46), None, None, (4203, 51), (4254, 42), None, (4296, 14), None, (4310, 15), (4325, 8), (4333, 21), (4354, 6), (4360, 16), (4376, 17)], [(4393, 6262), (10655, 6796), (17451, 7158), (24609, 6013), (30622, 6383), (37005, 6121), (43126, 6986), (50112, 6321), (56433, 6925), (63358, 6144), (69502, 7137), (76639, 6538), (83177, 6777), (89954, 7181), (97135, 6580), (103715, 6516), (110231, 7051), (117282, 6015), (123297, 6398), (129695, 6603), (136298, 7005), (143303, 6620), (149923, 6933), (156856, 6199), (163055, 6477), (169532, 6665), (176197, 6640), (182837, 6970), (189807, 6378), (196185, 6750), (202935, 6894), (209829, 6572), (216401, 6525), (222926, 7115), (230041, 6219), (236260, 6901), (243161, 6235), (249396, 7034), (256430, 6832), (263262, 6975), (270237, 7578), (277815, 6480), (284295, 6363), (290658, 6241), (296899, 6402), (303301, 6160), (309461, 6445), (315906, 7094), (323000, 6515), (329515, 5932), (335447, 6501), (341948, 6661), (348609, 6596), (355205, 6812), (362017, 6905), (368922, 6873), (375795, 6945), (382740, 6021), (388761, 6997), (395758, 5881), (401639, 6722), (408361, 6456), (414817, 6426), (421243, 6899), (428142, 6705), (434847, 6616), (441463, 6277), (447740, 7141), (454881, 6769), (461650, 6835), (468485, 6593), (475078, 6610), (481688, 5776), (487464, 7082), (494546, 7164), (501710, 7171), (508881, 6207), (515088, 7254), (522342, 7127), (529469, 6124), (535593, 6838), (542431, 5751), (548182, 6456), (554638, 6677), (561315, 6527), (567842, 6466), (574308, 6688), (580996, 6673), (587669, 6822), (594491, 6643), (601134, 7299), (608433, 6066), (614499, 6384), (620883, 6612), (627495, 6526), (634021, 7167), (641188, 6995), (648183, 6576), (654759, 6249), (661008, 6197), (667205, 6339), (673544, 6824), (680368, 6254), (686622, 6493), (693115, 6260), (699375, 6932), (706307, 6711), (713018, 7063), (720081, 8044), (728125, 7161), (735286, 7010), (742296, 6519), (748815, 6384), (755199, 6723), (761922, 6971), (768893, 6726), (775619, 6321), (781940, 6418), (788358, 6405), (794763, 7156), (801919, 6890), (808809, 6952), (815761, 7047), (822808, 6970), (829778, 7894), (837672, 6486), (844158, 5870), (850028, 6926), (856954, 6623), (863577, 8102), (871679, 7118), (878797, 6196), (884993, 6849), (891842, 6901), (898743, 6363), (905106, 6768), (911874, 6268), (918142, 6833), (924975, 6526), (931501, 6555), (938056, 6627), (944683, 7297), (951980, 6328), (958308, 6319), (964627, 6588), (971215, 6628), (977843, 6589), (984432, 6882), (991314, 6273), (997587, 7209), (1004796, 6724), (1011520, 6768), (1018288, 6930), (1025218, 6557), (1031775, 6673), (1038448, 6641), (1045089, 6446), (1051535, 6540), (1058075, 6337), (1064412, 6061), (1070473, 6252), (1076725, 6733), (1083458, 7290), (1090748, 6175), (1096923, 6664), (1103587, 6955), (1110542, 6454), (1116996, 6219), (1123215, 7038), (1130253, 6565), (1136818, 6013), (1142831, 6510), (1149341, 7766), (1157107, 6165), (1163272, 6265), (1169537, 6777), (1176314, 6337), (1182651, 6727), (1189378, 6435), (1195813, 6066), (1201879, 7525), (1209404, 6896), (1216300, 6515), (1222815, 7056), (1229871, 7467), (1237338, 7344), (1244682, 6218), (1250900, 7021), (1257921, 6329), (1264250, 6639), (1270889, 6837), (1277726, 6249), (1283975, 6965), (1290940, 7106), (1298046, 6597), (1304643, 6730), (1311373, 6483), (1317856, 6569), (1324425, 6808), (1331233, 6379), (1337612, 6768), (1344380, 6048), (1350428, 7192), (1357620, 6906), (1364526, 6686), (1371212, 7040), (1378252, 5848), (1384100, 6768), (1390868, 6538), (1397406, 6899), (1404305, 6865), (1411170, 7207), (1418377, 6708), (1425085, 6942), (1432027, 6957), (1438984, 6422), (1445406, 6562), (1451968, 6590), (1458558, 6668), (1465226, 6487), (1471713, 6607), (1478320, 6064), (1484384, 7587), (1491971, 6741), (1498712, 6360), (1505072, 6664), (1511736, 6823), (1518559, 5946), (1524505, 6775), (1531280, 6617), (1537897, 7573), (1545470, 6548), (1552018, 6076), (1558094, 7067), (1565161, 6401), (1571562, 7243), (1578805, 6295), (1585100, 6318), (1591418, 5902), (1597320, 6678), (1603998, 6523), (1610521, 6908), (1617429, 6367), (1623796, 6622), (1630418, 6589), (1637007, 7124), (1644131, 6434), (1650565, 5921), (1656486, 6658), (1663144, 6286), (1669430, 6822), (1676252, 6934), (1683186, 7119), (1690305, 6317), (1696622, 6331), (1702953, 6784)], [(1709737, 722), (1710459, 625), (1711084, 665), (1711749, 703), (1712452, 537), (1712989, 649), (1713638, 671), (1714309, 836), (1715145, 640), (1715785, 645), (1716430, 536), (1716966, 574), (1717540, 758), (1718298, 866), (1719164, 987), (1720151, 731), (1720882, 1224), (1722106, 624), (1722730, 875), (1723605, 673), (1724278, 724), (1725002, 746), (1725748, 853), (1726601, 731), (1727332, 703), (1728035, 646), (1728681, 955), (1729636, 1131), (1730767, 807), (1731574, 734), (1732308, 922), (1733230, 787), (1734017, 568), (1734585, 728), (1735313, 748), (1736061, 789), (1736850, 644), (1737494, 726), (1738220, 730), (1738950, 1062), (1740012, 695), (1740707, 812), (1741519, 705), (1742224, 719), (1742943, 728), (1743671, 378), (1744049, 908), (1744957, 857), (1745814, 721), (1746535, 568), (1747103, 834), (1747937, 671), (1748608, 780), (1749388, 1012), (1750400, 944), (1751344, 558), (1751902, 661), (1752563, 527), (1753090, 578), (1753668, 751), (1754419, 772), (1755191, 776), (1755967, 1041), (1757008, 915), (1757923, 706), (1758629, 719), (1759348, 767), (1760115, 475), (1760590, 595), (1761185, 556), (1761741, 692), (1762433, 877), (1763310, 568), (1763878, 725), (1764603, 650), (1765253, 702), (1765955, 552), (1766507, 672), (1767179, 806), (1767985, 461), (1768446, 754), (1769200, 629), (1769829, 828), (1770657, 623), (1771280, 607), (1771887, 425), (1772312, 597), (1772909, 725), (1773634, 781), (1774415, 772), (1775187, 853), (1776040, 1092), (1777132, 826), (1777958, 833), (1778791, 725), (1779516, 436), (1779952, 955), (1780907, 878), (1781785, 580), (1782365, 647), (1783012, 728), (1783740, 854), (1784594, 855), (1785449, 571), (1786020, 632), (1786652, 740), (1787392, 395), (1787787, 479), (1788266, 924), (1789190, 897), (1790087, 831), (1790918, 793), (1791711, 632), (1792343, 771), (1793114, 659), (1793773, 699), (1794472, 709), (1795181, 469), (1795650, 683), (1796333, 692), (1797025, 914), (1797939, 679), (1798618, 804), (1799422, 461), (1799883, 703), (1800586, 755), (1801341, 835), (1802176, 908), (1803084, 781), (1803865, 904), (1804769, 791), (1805560, 524), (1806084, 795), (1806879, 615), (1807494, 783), (1808277, 747), (1809024, 702), (1809726, 681), (1810407, 635), (1811042, 673), (1811715, 621), (1812336, 674), (1813010, 694), (1813704, 632), (1814336, 473), (1814809, 587), (1815396, 661), (1816057, 577), (1816634, 717), (1817351, 594), (1817945, 773), (1818718, 514), (1819232, 510), (1819742, 656), (1820398, 612), (1821010, 642), (1821652, 639), (1822291, 870), (1823161, 610), (1823771, 622), (1824393, 874), (1825267, 848), (1826115, 543), (1826658, 695), (1827353, 854), (1828207, 662), (1828869, 675), (1829544, 455), (1829999, 609), (1830608, 660), (1831268, 754), (1832022, 598), (1832620, 932), (1833552, 708), (1834260, 807), (1835067, 721), (1835788, 668), (1836456, 586), (1837042, 664), (1837706, 720), (1838426, 1353), (1839779, 561), (1840340, 643), (1840983, 650), (1841633, 1001), (1842634, 771), (1843405, 764), (1844169, 546), (1844715, 587), (1845302, 823), (1846125, 601), (1846726, 589), (1847315, 828), (1848143, 650), (1848793, 895), (1849688, 810), (1850498, 714), (1851212, 710), (1851922, 868), (1852790, 637), (1853427, 909), (1854336, 644), (1854980, 762), (1855742, 570), (1856312, 742), (1857054, 483), (1857537, 828), (1858365, 823), (1859188, 665), (1859853, 916), (1860769, 775), (1861544, 849), (1862393, 920), (1863313, 1077), (1864390, 863), (1865253, 648), (1865901, 877), (1866778, 702), (1867480, 508), (1867988, 443), (1868431, 794), (1869225, 762), (1869987, 419), (1870406, 1001), (1871407, 488), (1871895, 778), (1872673, 863), (1873536, 792), (1874328, 784), (1875112, 696), (1875808, 788), (1876596, 728), (1877324, 784), (1878108, 607), (1878715, 579), (1879294, 408), (1879702, 666), (1880368, 484), (1880852, 798), (1881650, 855), (1882505, 764), (1883269, 718), (1883987, 658), (1884645, 589), (1885234, 848), (1886082, 495), (1886577, 606), (1887183, 780), (1887963, 494), (1888457, 870), (1889327, 2090), (1891417, 548), (1891965, 707), (1892672, 890), (1893562, 900), (1894462, 510)], [(1894972, 48), None, (1895020, 35), (1895055, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1895097, 42), None, (1895139, 25), (1895164, 44), (1895208, 22), (1895230, 18), None, None, None, None, (1895248, 26), None, None, None, None, (1895274, 21), (1895295, 25), None, None, (1895320, 26), None, None, None, None, (1895346, 44), (1895390, 21), (1895411, 23), None, None, None, None, (1895434, 48), None, None, None, None, None, (1895482, 31), None, None, None, None, (1895513, 42), None, (1895555, 22), None, (1895577, 21), None, (1895598, 26), (1895624, 42), None, None, (1895666, 77), None, None, None, None, None, (1895743, 21), (1895764, 21), None, None, (1895785, 34), (1895819, 42), None, None, None, (1895861, 25), None, None, (1895886, 21), None, None, None, None, None, (1895907, 24), (1895931, 21), None, None, (1895952, 26), None, (1895978, 18), None, (1895996, 54), None, None, None, None, None, None, (1896050, 26), None, (1896076, 19), None, (1896095, 20), None, None, (1896115, 42), (1896157, 42), (1896199, 17), None, (1896216, 26), None, (1896242, 26), None, None, None, (1896268, 26), (1896294, 20), (1896314, 26), None, (1896340, 42), (1896382, 63), None, None, None, (1896445, 40), (1896485, 48), None, None, None, (1896533, 47), None, None, None, None, None, None, None, (1896580, 42), None, (1896622, 55), None, (1896677, 9), None, (1896686, 21), (1896707, 42), None, None, (1896749, 42), (1896791, 82), None, None, (1896873, 42), None, None, None, None, None, None, None, None, None, (1896915, 42), (1896957, 21), (1896978, 21), None, (1896999, 42), (1897041, 25), None, None, (1897066, 21), (1897087, 42), None, None, (1897129, 21), (1897150, 19), (1897169, 26), None, None, None, (1897195, 21), None, None, (1897216, 38), None, (1897254, 22), (1897276, 21), (1897297, 21), None, None, (1897318, 63), None, (1897381, 21), (1897402, 42), None, (1897444, 17), None, None, None, None, (1897461, 21), (1897482, 21), None, None, (1897503, 21), None, None, (1897524, 21), None, (1897545, 26), None, (1897571, 50), None, None, None, (1897621, 50), (1897671, 26), (1897697, 21), (1897718, 21), (1897739, 19), None, (1897758, 35), (1897793, 26), (1897819, 23), (1897842, 21), (1897863, 42), None, None, None, None, None, None, (1897905, 21), None, None, None, (1897926, 21), None, None, (1897947, 90), None, (1898037, 239), (1898276, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
